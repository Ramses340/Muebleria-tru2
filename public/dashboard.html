<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Mueblería</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }
    .navbar {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .card {
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .table-responsive {
      margin-top: 20px;
    }
    .action-buttons {
      gap: 5px;
    }
    .btn-sm {
      padding: 0.3rem 0.6rem;
      font-size: 0.85rem;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-shop"></i> Mueblería Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <span id="userInfo" class="navbar-text me-3"></span>
          </li>
          <li class="nav-item">
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
              <i class="bi bi-box-arrow-right"></i> Salir
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2">
        <div class="list-group sticky-top">
          <button class="list-group-item list-group-item-action active" onclick="showSection('productos')">
            <i class="bi bi-box2"></i> Productos
          </button>
          <button class="list-group-item list-group-item-action" onclick="showSection('detalleVenta')">
            <i class="bi bi-receipt"></i> Detalles de Venta
          </button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="col-md-10">

        <!-- SECCIÓN: PRODUCTOS -->
        <div id="productos" class="section active">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-box2"></i> Gestionar Productos</h5>
            </div>
            <div class="card-body">
              <!-- Formulario crear/editar -->
              <div class="row mb-3">
                <div class="col-md-3">
                  <label class="form-label">Nombre</label>
                  <input type="text" id="prodNombre" class="form-control" placeholder="Ej: Silla">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Precio</label>
                  <input type="number" id="prodPrecio" class="form-control" placeholder="Ej: 150.50" step="0.01">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Stock</label>
                  <input type="number" id="prodStock" class="form-control" placeholder="Ej: 10" min="0">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <button class="btn btn-success w-100" onclick="guardarProducto()">
                    <i class="bi bi-plus-circle"></i> Guardar
                  </button>
                </div>
              </div>

              <!-- Tabla de productos -->
              <div class="table-responsive">
                <table class="table table-hover table-bordered">
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Nombre</th>
                      <th>Precio</th>
                      <th>Stock</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="productosTable">
                    <tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN: DETALLES DE VENTA -->
        <div id="detalleVenta" class="section">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="bi bi-receipt"></i> Gestionar Detalles de Venta</h5>
            </div>
            <div class="card-body">
              <!-- Formulario crear/editar -->
              <div class="row mb-3">
                <div class="col-md-2">
                  <label class="form-label">Venta ID</label>
                  <input type="number" id="detVentaId" class="form-control" placeholder="Ej: 1" min="1">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Producto ID</label>
                  <input type="number" id="detProductoId" class="form-control" placeholder="Ej: 1" min="1">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Cantidad</label>
                  <input type="number" id="detCantidad" class="form-control" placeholder="Ej: 2" min="1">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Precio Unitario</label>
                  <input type="number" id="detPrecioUnitario" class="form-control" placeholder="Ej: 150.50" step="0.01">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button class="btn btn-success w-100" onclick="guardarDetalleVenta()">
                    <i class="bi bi-plus-circle"></i> Guardar
                  </button>
                </div>
              </div>

              <!-- Tabla de detalles de venta -->
              <div class="table-responsive">
                <table class="table table-hover table-bordered">
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Venta ID</th>
                      <th>Producto ID</th>
                      <th>Cantidad</th>
                      <th>Precio Unitario</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="detalleVentaTable">
                    <tr><td colspan="6" class="text-center text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal para editar producto -->
  <div class="modal fade" id="editProdModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editProdId">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" id="editProdNombre" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Precio</label>
            <input type="number" id="editProdPrecio" class="form-control" step="0.01">
          </div>
          <div class="mb-3">
            <label class="form-label">Stock</label>
            <input type="number" id="editProdStock" class="form-control" min="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="actualizarProducto()">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar detalle venta -->
  <div class="modal fade" id="editDetModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Detalle de Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editDetId">
          <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" id="editDetCantidad" class="form-control" min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">Precio Unitario</label>
            <input type="number" id="editDetPrecioUnitario" class="form-control" step="0.01">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="actualizarDetalleVenta()">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_URL = '/api';
    let token = localStorage.getItem('token');
    let currentEditProdId = null;
    let currentEditDetId = null;

    // Verificar autenticación
    window.addEventListener('load', () => {
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Obtener usuario desde JWT (decodificar)
      const payload = JSON.parse(atob(token.split('.')[1]));
      document.getElementById('userInfo').textContent = `Bienvenido, ${payload.nombre}`;
      
      // Cargar datos iniciales
      cargarProductos();
      cargarDetallesVenta();
    });

    // Cambiar sección
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      
      document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
    }

    // ============ PRODUCTOS ============

    async function cargarProductos() {
      try {
        const res = await fetch(`${API_URL}/productos`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al cargar productos');
        
        const productos = await res.json();
        renderProductosTable(productos);
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'No se pudieron cargar los productos', 'error');
        document.getElementById('productosTable').innerHTML = '<tr><td colspan="5" class="text-danger">Error al cargar</td></tr>';
      }
    }

    function renderProductosTable(productos) {
      const table = document.getElementById('productosTable');
      
      if (productos.length === 0) {
        table.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay productos</td></tr>';
        return;
      }

      table.innerHTML = productos.map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>$${parseFloat(p.precio).toFixed(2)}</td>
          <td>${p.stock}</td>
          <td>
            <div class="action-buttons d-flex">
              <button class="btn btn-sm btn-warning" onclick="abrirEditProd(${p.id}, '${p.nombre}', ${p.precio}, ${p.stock})">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.id})">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function guardarProducto() {
      const nombre = document.getElementById('prodNombre').value.trim();
      const precio = parseFloat(document.getElementById('prodPrecio').value);
      const stock = parseInt(document.getElementById('prodStock').value);

      if (!nombre || !precio || isNaN(stock)) {
        Swal.fire('Error', 'Completa todos los campos correctamente', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/productos`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nombre, precio, stock })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Error al crear producto');
        }

        Swal.fire('Éxito', 'Producto creado correctamente', 'success');
        document.getElementById('prodNombre').value = '';
        document.getElementById('prodPrecio').value = '';
        document.getElementById('prodStock').value = '';
        cargarProductos();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    function abrirEditProd(id, nombre, precio, stock) {
      currentEditProdId = id;
      document.getElementById('editProdId').value = id;
      document.getElementById('editProdNombre').value = nombre;
      document.getElementById('editProdPrecio').value = precio;
      document.getElementById('editProdStock').value = stock;
      new bootstrap.Modal(document.getElementById('editProdModal')).show();
    }

    async function actualizarProducto() {
      const id = currentEditProdId;
      const nombre = document.getElementById('editProdNombre').value.trim();
      const precio = parseFloat(document.getElementById('editProdPrecio').value);
      const stock = parseInt(document.getElementById('editProdStock').value);

      if (!nombre || !precio || isNaN(stock)) {
        Swal.fire('Error', 'Completa todos los campos', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/productos/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nombre, precio, stock })
        });

        if (!res.ok) throw new Error('Error al actualizar');

        Swal.fire('Éxito', 'Producto actualizado', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editProdModal')).hide();
        cargarProductos();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    async function eliminarProducto(id) {
      const confirm = await Swal.fire({
        title: '¿Eliminar producto?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar'
      });

      if (!confirm.isConfirmed) return;

      try {
        const res = await fetch(`${API_URL}/productos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al eliminar');

        Swal.fire('Éxito', 'Producto eliminado', 'success');
        cargarProductos();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    // ============ DETALLES DE VENTA ============

    async function cargarDetallesVenta() {
      try {
        // Nota: esto cargará todos los detalles; si tienes muchos, considera paginar o filtrar por venta_id
        const res = await fetch(`${API_URL}/detalleVenta`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al cargar detalles');
        
        const detalles = await res.json();
        renderDetalleVentaTable(detalles);
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'No se pudieron cargar los detalles de venta', 'error');
        document.getElementById('detalleVentaTable').innerHTML = '<tr><td colspan="6" class="text-danger">Error al cargar</td></tr>';
      }
    }

    function renderDetalleVentaTable(detalles) {
      const table = document.getElementById('detalleVentaTable');
      
      if (!Array.isArray(detalles) || detalles.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay detalles de venta</td></tr>';
        return;
      }

      table.innerHTML = detalles.map(d => `
        <tr>
          <td>${d.id}</td>
          <td>${d.venta_id}</td>
          <td>${d.producto_id}</td>
          <td>${d.cantidad}</td>
          <td>$${parseFloat(d.precio_unitario).toFixed(2)}</td>
          <td>
            <div class="action-buttons d-flex">
              <button class="btn btn-sm btn-warning" onclick="abrirEditDet(${d.id}, ${d.cantidad}, ${d.precio_unitario})">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger" onclick="eliminarDetalleVenta(${d.id})">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function guardarDetalleVenta() {
      const venta_id = parseInt(document.getElementById('detVentaId').value);
      const producto_id = parseInt(document.getElementById('detProductoId').value);
      const cantidad = parseInt(document.getElementById('detCantidad').value);
      const precio_unitario = parseFloat(document.getElementById('detPrecioUnitario').value);

      if (isNaN(venta_id) || isNaN(producto_id) || isNaN(cantidad) || isNaN(precio_unitario)) {
        Swal.fire('Error', 'Completa todos los campos correctamente', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/detalleVenta`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ venta_id, producto_id, cantidad, precio_unitario })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Error al crear');
        }

        Swal.fire('Éxito', 'Detalle de venta creado', 'success');
        document.getElementById('detVentaId').value = '';
        document.getElementById('detProductoId').value = '';
        document.getElementById('detCantidad').value = '';
        document.getElementById('detPrecioUnitario').value = '';
        cargarDetallesVenta();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    function abrirEditDet(id, cantidad, precio_unitario) {
      currentEditDetId = id;
      document.getElementById('editDetId').value = id;
      document.getElementById('editDetCantidad').value = cantidad;
      document.getElementById('editDetPrecioUnitario').value = precio_unitario;
      new bootstrap.Modal(document.getElementById('editDetModal')).show();
    }

    async function actualizarDetalleVenta() {
      const id = currentEditDetId;
      const cantidad = parseInt(document.getElementById('editDetCantidad').value);
      const precio_unitario = parseFloat(document.getElementById('editDetPrecioUnitario').value);

      if (isNaN(cantidad) || isNaN(precio_unitario)) {
        Swal.fire('Error', 'Completa los campos', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/detalleVenta/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ cantidad, precio_unitario })
        });

        if (!res.ok) throw new Error('Error al actualizar');

        Swal.fire('Éxito', 'Detalle actualizado', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editDetModal')).hide();
        cargarDetallesVenta();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    async function eliminarDetalleVenta(id) {
      const confirm = await Swal.fire({
        title: '¿Eliminar detalle?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar'
      });

      if (!confirm.isConfirmed) return;

      try {
        const res = await fetch(`${API_URL}/detalleVenta/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al eliminar');

        Swal.fire('Éxito', 'Detalle eliminado', 'success');
        cargarDetallesVenta();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    // Logout
    function logout() {
      Swal.fire({
        title: '¿Salir?',
        text: 'Se cerrará tu sesión',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, salir'
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem('token');
          window.location.href = '/login.html';
        }
      });
    }
  </script>

</body>
</html>
