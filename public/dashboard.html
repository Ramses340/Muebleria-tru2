<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Mueblería</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
  /* ===== PALETA DARK BLUE ELEGANTE ===== */
:root {
  --azul-oscuro: #0D1B2A;
  --azul-panel: #1B263B;
  --azul-card: #27344D;
  --azul-acento: #3282B8;
  --azul-hover: #4A9FD8;
  --azul-claro: #BBE1FA;

  --gris-claro: #D0D0D0;
  --blanco: #F5F5F5;
}
/* === INPUTS CON TEXTO Y PLACEHOLDER BLANCO === */

.form-control,
.form-select {
  background-color: #ffffff !important; /* fondo blanco */
  color: #000000 !important;            /* texto negro para que se lea */
  border: 1px solid #2c3e50;
  border-radius: 6px;
}

/* ===== BASE ===== */
body {
  background-color: var(--azul-oscuro);
  color: var(--blanco);
  font-family: Arial, sans-serif;
}

/* ===== NAVBAR ===== */
.navbar {
  background-color: var(--azul-panel) !important;
  border-bottom: 1px solid #223047;
}

.navbar-nav .nav-link {
  color: var(--gris-claro) !important;
}

.navbar-nav .nav-link:hover {
  color: var(--azul-claro) !important;
}

/* ===== SIDEBAR ===== */
.list-group-item {
  background-color: var(--azul-panel);
  border: 1px solid #223047;
  color: var(--blanco);
}

.list-group-item.active {
  background-color: var(--azul-acento);
  border-color: var(--azul-acento);
}

/* ===== CARDS ===== */
.card {
  background-color: var(--azul-card);
  color: var(--blanco);
  border: 1px solid #1f2c3d;
}

.card-header {
  background-color: var(--azul-panel);
  border-bottom: 1px solid #223047;
}

/* ===== TABLAS ===== */

/* Fondo general y bordes un poco redondeados */
table.table {
  background-color: #2E3F5F !important; /* Azul un poco más claro */
  color: var(--blanco) !important;
  border-radius: 12px !important;
  overflow: hidden;
  border: 1px solid #1f2c3d !important;
}

/* Cabecera */
thead.table-dark th {
  background-color: #3B4F72 !important; /* Azul intermedio */
  color: var(--azul-claro) !important;
  border-color: #4B5E86 !important;
}

/* Filas */
tbody tr {
  background-color: #2E3F5F !important;
  transition: background-color 0.25s ease;
}

/* Hover */
tbody tr:hover {
  background-color: #4467A3 !important; /* Azul brillante */
  color: var(--blanco) !important;
}

/* Bordes y paddings */
.table td,
.table th {
  border-color: #1f2c3d !important;
  padding: 10px !important;
}

#detalleTable th:nth-child(2),
#detalleTable td:nth-child(2) {
  display: none !important;
}


/* ===== BOTONES ===== */
.btn-primary {
  background-color: var(--azul-acento);
  border-color: var(--azul-acento);
}

.btn-primary:hover {
  background-color: var(--azul-hover);
  border-color: var(--azul-hover);
}

.btn-danger {
  background-color: #C62828;
  border-color: #C62828;
}

.btn-danger:hover {
  background-color: #E53935;
  border-color: #E53935;
}

.btn-secondary {
  background-color: var(--azul-panel);
  border-color: var(--azul-panel);
  color: var(--gris-claro);
}

.btn-secondary:hover {
  background-color: var(--azul-card);
}

/* ===== INPUTS ===== */
.form-control,
.form-select {
  background-color: var(--azul-card);
  color: var(--blanco);
  border: 1px solid #1f2c3d;
}

.form-control:focus,
.form-select:focus {
  background-color: var(--azul-card);
  color: var(--blanco);
  border-color: var(--azul-acento);
  box-shadow: 0 0 0 0.2rem rgba(50, 130, 184, 0.25);
}

/* ===== MODAL ===== */
.modal-content {
  background-color: var(--azul-panel);
  color: var(--blanco);
  border: 1px solid #223047;
}

.modal-header,
.modal-footer {
  border-color: #223047;
}

/* ===== ICONOS ===== */
i {
  color: var(--azul-claro);
}

i:hover {
  color: var(--azul-hover);
}

</style>

</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="bi bi-shop"></i> Mueblería Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <span id="userInfo" class="navbar-text me-3"></span>
          </li>
          <li class="nav-item">
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
              <i class="bi bi-box-arrow-right"></i> Salir
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-2">
        <div class="list-group sticky-top">
          <button class="list-group-item list-group-item-action active" onclick="showSection('productos')">
            <i class="bi bi-box2"></i> Productos
          </button>
          <button class="list-group-item list-group-item-action" onclick="showSection('detalleVenta')">
            <i class="bi bi-receipt"></i> Detalles de Venta
          </button>
        </div>
      </div>

      <!-- Content Area -->
      <div class="col-md-10">

        <!-- SECCIÓN: PRODUCTOS -->
        <div id="productos" class="section active">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-box2"></i> Gestionar Productos</h5>
            </div>
            <div class="card-body">
              <!-- Formulario crear/editar -->
              <div class="row mb-3">
                <div class="col-md-3">
                  <label class="form-label">Nombre</label>
                  <input type="text" id="prodNombre" class="form-control" placeholder="Ej: Silla">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Precio</label>
                  <input type="number" id="prodPrecio" class="form-control" placeholder="Ej: 150.50" step="0.01">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Stock</label>
                  <input type="number" id="prodStock" class="form-control" placeholder="Ej: 10" min="0">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <button class="btn btn-success w-100" onclick="guardarProducto()">
                    <i class="bi bi-plus-circle"></i> Guardar
                  </button>
                </div>
              </div>

              <!-- Tabla de productos -->
              <div class="table-responsive">
                <table id="detalleTable" class="table table-hover table-bordered">
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Nombre</th>
                      <th>Precio</th>
                      <th>Stock</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="productosTable">
                    <tr><td colspan="5" class="text-center text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
              <!-- Gráficas: Stock y Precios -->
              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="card p-3">
                    <h6 class="mb-2">Productos en Stock</h6>
                    <canvas id="stockChart" width="400" height="260" style="width:100%;height:260px;"></canvas>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card p-3">
                    <h6 class="mb-2">Producto con Mayor Precio</h6>
                    <canvas id="priceChart" width="400" height="260" style="width:100%;height:260px;"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN: DETALLES DE VENTA -->
        <div id="detalleVenta" class="section">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="bi bi-receipt"></i> Crear Detalle de Venta (Ticket)</h5>
            </div>
            <div class="card-body">
              <!-- Formulario crear detalle de venta -->
              <div class="row mb-4">
                <div class="col-md-3">
                  <label class="form-label"><strong>Venta ID</strong></label>
                  <input type="number" id="detVentaId" class="form-control" placeholder="Ej: 1" min="1">
                </div>
                <div class="col-md-4">
                  <label class="form-label"><strong>Seleccionar Producto</strong></label>
                  <select id="detProductoSelect" class="form-select" onchange="cargarDetallesProducto()">
                    <option value="">-- Selecciona un producto --</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label"><strong>Cantidad</strong></label>
                  <input type="number" id="detCantidad" class="form-control" placeholder="Ej: 2" min="1" value="1" onchange="calcularSubtotal()">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <button class="btn btn-success w-100" onclick="guardarDetalleVenta()">
                    <i class="bi bi-plus-circle"></i> Agregar a Venta
                  </button>
                </div>
              </div>

              <!-- Información del producto seleccionado -->
              <div id="productoInfoDiv" class="alert alert-light border mb-4" style="display: none;">
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-primary"><strong>Producto:</strong> <span id="infoProdNombre"></span></h6>
                    <p class="mb-2"><strong>Descripción:</strong> <span id="infoProdDesc" class="text-muted"></span></p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-2"><strong>Precio Unitario:</strong> $<span id="infoProdPrecio" class="text-success fw-bold"></span></p>
                    <p class="mb-2"><strong>Stock Disponible:</strong> <span id="infoProdStock" class="badge bg-secondary"></span></p>
                  </div>
                </div>
                <hr>
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-info">Subtotal: $<span id="infoProdSubtotal" class="fw-bold">0.00</span></h6>
                  </div>
                </div>
              </div>

              <!-- Tabla de detalles de venta (como recibo) -->
              <h5 class="mt-5 mb-3"><i class="bi bi-receipt-cutoff"></i> Detalles de Ventas Registrados</h5>
              <div class="table-responsive">
                <table class="table table-hover table-bordered">
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Venta ID</th>
                      <th>Producto</th>
                      <th>Descripción</th>
                      <th>Cantidad</th>
                      <th>Precio Unit.</th>
                      <th>Subtotal</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="detalleVentaTable">
                    <tr><td colspan="8" class="text-center text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Modal para editar producto -->
  <div class="modal fade" id="editProdModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editProdId">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" id="editProdNombre" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Precio</label>
            <input type="number" id="editProdPrecio" class="form-control" step="0.01">
          </div>
          <div class="mb-3">
            <label class="form-label">Stock</label>
            <input type="number" id="editProdStock" class="form-control" min="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="actualizarProducto()">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para editar detalle venta -->
  <div class="modal fade" id="editDetModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Detalle de Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editDetId">
          <div class="mb-3">
            <label class="form-label">Cantidad</label>
            <input type="number" id="editDetCantidad" class="form-control" min="1">
          </div>
          <div class="mb-3">
            <label class="form-label">Precio Unitario</label>
            <input type="number" id="editDetPrecioUnitario" class="form-control" step="0.01">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="actualizarDetalleVenta()">Actualizar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_URL = '/api';
    let token = localStorage.getItem('token');
    let currentEditProdId = null;
    let currentEditDetId = null;

    // Verificar autenticación
    window.addEventListener('load', () => {
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Obtener usuario desde JWT (decodificar)
      const payload = JSON.parse(atob(token.split('.')[1]));
      document.getElementById('userInfo').textContent = `Bienvenido, ${payload.nombre}`;
      
      // Cargar datos iniciales
      cargarProductos();
      cargarProductosEnSelect();
      cargarDetallesVenta();
    });

    // Cambiar sección
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      
      document.querySelectorAll('.list-group-item').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
    }

    // ============ PRODUCTOS ============

    async function cargarProductos() {
      try {
        const res = await fetch(`${API_URL}/productos`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al cargar productos');
        
        const productos = await res.json();
        renderProductosTable(productos);
        if (typeof renderCharts === 'function') renderCharts(productos);
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'No se pudieron cargar los productos', 'error');
        document.getElementById('productosTable').innerHTML = '<tr><td colspan="5" class="text-danger">Error al cargar</td></tr>';
      }
    }

    function renderProductosTable(productos) {
      const table = document.getElementById('productosTable');
      
      if (productos.length === 0) {
        table.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay productos</td></tr>';
        return;
      }

      table.innerHTML = productos.map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${p.nombre}</td>
          <td>$${parseFloat(p.precio).toFixed(2)}</td>
          <td>${p.stock}</td>
          <td>
            <div class="action-buttons d-flex">
              <button class="btn btn-sm btn-warning" onclick="abrirEditProd(${p.id}, '${p.nombre}', ${p.precio}, ${p.stock})">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${p.id})">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function guardarProducto() {
      const nombre = document.getElementById('prodNombre').value.trim();
      const precio = parseFloat(document.getElementById('prodPrecio').value);
      const stock = parseInt(document.getElementById('prodStock').value);

      if (!nombre || !precio || isNaN(stock)) {
        Swal.fire('Error', 'Completa todos los campos correctamente', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/productos`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nombre, precio, stock })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Error al crear producto');
        }

        Swal.fire('Éxito', 'Producto creado correctamente', 'success');
        document.getElementById('prodNombre').value = '';
        document.getElementById('prodPrecio').value = '';
        document.getElementById('prodStock').value = '';
        cargarProductos();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    function abrirEditProd(id, nombre, precio, stock) {
      currentEditProdId = id;
      document.getElementById('editProdId').value = id;
      document.getElementById('editProdNombre').value = nombre;
      document.getElementById('editProdPrecio').value = precio;
      document.getElementById('editProdStock').value = stock;
      new bootstrap.Modal(document.getElementById('editProdModal')).show();
    }

    async function actualizarProducto() {
      const id = currentEditProdId;
      const nombre = document.getElementById('editProdNombre').value.trim();
      const precio = parseFloat(document.getElementById('editProdPrecio').value);
      const stock = parseInt(document.getElementById('editProdStock').value);

      if (!nombre || !precio || isNaN(stock)) {
        Swal.fire('Error', 'Completa todos los campos', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/productos/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ nombre, precio, stock })
        });

        if (!res.ok) throw new Error('Error al actualizar');

        Swal.fire('Éxito', 'Producto actualizado', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editProdModal')).hide();
        cargarProductos();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    async function eliminarProducto(id) {
      const confirm = await Swal.fire({
        title: '¿Eliminar producto?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar'
      });

      if (!confirm.isConfirmed) return;

      try {
        const res = await fetch(`${API_URL}/productos/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al eliminar');

        Swal.fire('Éxito', 'Producto eliminado', 'success');
        cargarProductos();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    // ====== GRÁFICAS (Canvas API) ======
    function renderCharts(productos) {
      try {
        if (!Array.isArray(productos)) return;
        const labels = productos.map(p => p.nombre);
        const stocks = productos.map(p => Number(p.stock || 0));
        const prices = productos.map(p => Number(p.precio || 0));

        drawBarChart('stockChart', labels, stocks, { color: '#4CAF50', title: 'Stock por Producto' });

        const maxPrice = Math.max(...prices);
        const maxIndex = prices.indexOf(maxPrice);
        drawBarChart('priceChart', labels, prices, { color: '#2196F3', highlightIndex: maxIndex, highlightColor: '#FF5722', title: 'Precio por Producto' });
      } catch (e) {
        console.error('Error renderCharts', e);
      }
    }

    function drawBarChart(canvasId, labels, values, opts = {}) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      // HiDPI support
      const DPR = window.devicePixelRatio || 1;
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      canvas.width = Math.floor(w * DPR);
      canvas.height = Math.floor(h * DPR);
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

      // Clear
      ctx.clearRect(0, 0, w, h);

      const padding = 90; 
      const chartW = w - padding * 2;
      const chartH = h - padding * 2;

      const maxVal = Math.max(1, ...values);
      const barGap = 8;
      const barWidth = Math.max(6, (chartW - (labels.length - 1) * barGap) / labels.length);

      // Title
      if (opts.title) {
        ctx.fillStyle = '#ffffff';
        ctx.font = '14px Arial';
        ctx.fillText(opts.title, padding, 16);
      }

      // Draw bars
      labels.forEach((lbl, i) => {
        const val = values[i] || 0;
        const x = padding + i * (barWidth + barGap);
        const barH = (val / maxVal) * (chartH - 30);
        const y = padding + (chartH - barH) + 12;

        // bar color
        let color = opts.color || '#4CAF50';
        if (typeof opts.highlightIndex === 'number' && i === opts.highlightIndex) {
          color = opts.highlightColor || '#FF5722';
        }

        // draw bar
        ctx.fillStyle = color;
        ctx.fillRect(x, y, barWidth, barH);

        // value label above bar
        ctx.fillStyle = '#ffffff';
        ctx.font = '11px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(String(val), x + barWidth / 2, y - 6);

        // x label (rotate if too long)
        ctx.save();
        ctx.translate(x + barWidth / 2, padding + chartH + 28);
        ctx.rotate(-Math.PI / 4);
        ctx.textAlign = 'right';
        ctx.fillStyle = '#dde6f6';
        ctx.font = '11px Arial';
        const shortLabel = lbl.length > 18 ? lbl.slice(0, 16) + '…' : lbl;
        ctx.fillText(shortLabel, 0, 0);
        ctx.restore();
      });
    }

    // ============ DETALLES DE VENTA ============

    let productosDisponibles = [];

    async function cargarProductosEnSelect() {
      try {
        const res = await fetch(`${API_URL}/productos`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al cargar productos');
        
        productosDisponibles = await res.json();
        const select = document.getElementById('detProductoSelect');
        select.innerHTML = '<option value="">-- Selecciona un producto --</option>';
        
        productosDisponibles.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = `${p.nombre} - $${parseFloat(p.precio).toFixed(2)}`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error(err);
      }
    }

    function cargarDetallesProducto() {
      const productoId = parseInt(document.getElementById('detProductoSelect').value);
      const infoDiv = document.getElementById('productoInfoDiv');
      
      if (!productoId) {
        infoDiv.style.display = 'none';
        return;
      }

      const producto = productosDisponibles.find(p => p.id === productoId);
      if (!producto) return;

      document.getElementById('infoProdNombre').textContent = producto.nombre;
      document.getElementById('infoProdDesc').textContent = producto.descripcion || 'Sin descripción';
      document.getElementById('infoProdPrecio').textContent = parseFloat(producto.precio).toFixed(2);
      document.getElementById('infoProdStock').textContent = producto.stock;
      
      infoDiv.style.display = 'block';
      calcularSubtotal();
    }

    function calcularSubtotal() {
      const productoId = parseInt(document.getElementById('detProductoSelect').value);
      const cantidad = parseInt(document.getElementById('detCantidad').value) || 1;
      
      if (!productoId) return;

      const producto = productosDisponibles.find(p => p.id === productoId);
      if (!producto) return;

      const subtotal = parseFloat(producto.precio) * cantidad;
      document.getElementById('infoProdSubtotal').textContent = subtotal.toFixed(2);
    }

    async function cargarDetallesVenta() {
      try {
        const res = await fetch(`${API_URL}/detalleVenta`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al cargar detalles');
        
        const detalles = await res.json();
        renderDetalleVentaTable(detalles);
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'No se pudieron cargar los detalles de venta', 'error');
        document.getElementById('detalleVentaTable').innerHTML = '<tr><td colspan="8" class="text-danger">Error al cargar</td></tr>';
      }
    }

    function renderDetalleVentaTable(detalles) {
      const table = document.getElementById('detalleVentaTable');
      
      if (!Array.isArray(detalles) || detalles.length === 0) {
        table.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No hay detalles de venta</td></tr>';
        return;
      }

      table.innerHTML = detalles.map(d => {
        const producto = productosDisponibles.find(p => p.id === d.producto_id);
        const subtotal = parseFloat(d.precio_unitario) * d.cantidad;
        
        return `
                    <tr>
          <td><strong>${d.id}</strong></td>
          <td>${d.venta_id}</td>
          <td>${producto ? producto.nombre : `Producto #${d.producto_id}`}</td>
          <td class="text-muted small">${producto ? producto.descripcion : 'N/A'}</td>
          <td class="text-center"><badge class="badge bg-info">${d.cantidad}</badge></td>
          <td>$${parseFloat(d.precio_unitario).toFixed(2)}</td>
          <td><strong>$${subtotal.toFixed(2)}</strong></td>
          <td>
              <div class="action-buttons d-flex" style="gap: 5px;">
                <button class="btn btn-sm btn-warning" onclick="abrirEditDet(${d.id}, ${d.cantidad}, ${d.precio_unitario})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="eliminarDetalleVenta(${d.id})">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function guardarDetalleVenta() {
      const venta_id = parseInt(document.getElementById('detVentaId').value);
      const producto_id = parseInt(document.getElementById('detProductoSelect').value);
      const cantidad = parseInt(document.getElementById('detCantidad').value);
      
      const producto = productosDisponibles.find(p => p.id === producto_id);
      if (!producto) {
        Swal.fire('Error', 'Selecciona un producto válido', 'warning');
        return;
      }

      const precio_unitario = parseFloat(producto.precio);

      if (isNaN(producto_id) || isNaN(cantidad) || isNaN(precio_unitario)) {
        Swal.fire('Error', 'Selecciona producto y cantidad válidos', 'warning');
        return;
      }

      if (cantidad > producto.stock) {
        Swal.fire('Error', `No hay suficiente stock. Disponible: ${producto.stock}`, 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/detalleVenta`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify((() => {
            const b = { producto_id, cantidad };
            if (!isNaN(venta_id)) b.venta_id = venta_id;
            return b;
          })())
        });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.message || 'Error al crear');
          }

          const created = await res.json();
          Swal.fire('Éxito', `${producto.nombre} agregado a la venta`, 'success');
          if (created && created.venta_id) {
            document.getElementById('detVentaId').value = created.venta_id;
          } else {
            document.getElementById('detVentaId').value = '';
          }
          document.getElementById('detProductoSelect').value = '';
          document.getElementById('detCantidad').value = '1';
          document.getElementById('productoInfoDiv').style.display = 'none';
          cargarDetallesVenta();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    function abrirEditDet(id, cantidad, precio_unitario) {
      currentEditDetId = id;
      document.getElementById('editDetId').value = id;
      document.getElementById('editDetCantidad').value = cantidad;
      document.getElementById('editDetPrecioUnitario').value = precio_unitario;
      new bootstrap.Modal(document.getElementById('editDetModal')).show();
    }

    async function actualizarDetalleVenta() {
      const id = currentEditDetId;
      const cantidad = parseInt(document.getElementById('editDetCantidad').value);
      const precio_unitario = parseFloat(document.getElementById('editDetPrecioUnitario').value);

      if (isNaN(cantidad) || isNaN(precio_unitario)) {
        Swal.fire('Error', 'Completa los campos', 'warning');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/detalleVenta/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ cantidad, precio_unitario })
        });

        if (!res.ok) throw new Error('Error al actualizar');

        Swal.fire('Éxito', 'Detalle actualizado', 'success');
        bootstrap.Modal.getInstance(document.getElementById('editDetModal')).hide();
        cargarDetallesVenta();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    async function eliminarDetalleVenta(id) {
      const confirm = await Swal.fire({
        title: '¿Eliminar detalle?',
        text: 'Esta acción no se puede deshacer',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, eliminar'
      });

      if (!confirm.isConfirmed) return;

      try {
        const res = await fetch(`${API_URL}/detalleVenta/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) throw new Error('Error al eliminar');

        Swal.fire('Éxito', 'Detalle eliminado', 'success');
        cargarDetallesVenta();
      } catch (err) {
        Swal.fire('Error', err.message, 'error');
      }
    }

    // Logout
    function logout() {
      Swal.fire({
        title: '¿Salir?',
        text: 'Se cerrará tu sesión',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, salir'
      }).then((result) => {
        if (result.isConfirmed) {
          localStorage.removeItem('token');
          window.location.href = '/login.html';
        }
      });
    }
  </script>

</body>
</html>
